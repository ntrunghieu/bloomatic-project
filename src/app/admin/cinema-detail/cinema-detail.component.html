<div class="page-wrap" *ngIf="cinema">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <span>Dashboard</span>
        <span>/</span>
        <a routerLink="/admin/cinemas/list">Danh sách rạp chiếu</a>
        <span>/</span>
        <span>{{ form.get('tenRap')?.value }}</span>
        <!-- <span>{{ cinema.tenRap }}</span> -->
    </nav>

    <!-- TOP: thông tin rạp + map -->
    <div class="top-grid">
        <div class="cinema-card">
            <div class="cinema-card__header">
                <div class="btn-group-left">
                    <button type="button" class="btn-outline" routerLink="/admin/cinemas/list" (click)="goBack()">
                        <i class="fa-solid fa-arrow-left"></i> Quay lại
                    </button>
                </div>
                <div class="btn-group-right">
                    <button type="button" class="btn-primary" (click)="updateCinema()">
                        Cập nhật
                    </button>
                    <button type="button" class="btn-danger" (click)="openDeleteCinema()">
                        Xóa rạp chiếu
                    </button>
                </div>
            </div>

            <form [formGroup]="form" (ngSubmit)="updateCinema()">
                <div class="field-group">
                    <label class="field-label">
                        Tên rạp chiếu <span class="required">*</span>
                    </label>
                    <input type="text" class="field-input" placeholder="Nhập tên rạp chiếu" formControlName="tenRap" />
                </div>

                <div class="field-group">
                    <label class="field-label">
                        Địa chỉ <span class="required">*</span>
                    </label>
                    <textarea rows="3" class="field-textarea" placeholder="Nhập địa chỉ"
                        formControlName="diaChi"></textarea>
                </div>

                <!-- <div class="field-group">
                    <label class="field-label">Địa chỉ map</label>
                    <textarea rows="3" class="field-textarea"
                        placeholder="Nhập địa chỉ map (đường dẫn embed Google Maps)"
                        formControlName="mapAddress"></textarea>
                </div> -->
            </form>
        </div>

        <!-- <div class="map-card">
            <h4 class="map-title">{{ form.get('name')?.value }}</h4>
            <p class="map-address">{{ form.get('address')?.value }}</p>
            <div class="map-frame">
                <iframe *ngIf="form.get('mapAddress')?.value" [src]="form.get('mapAddress')?.value | safeUrl"
                    loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                <div class="map-placeholder" *ngIf="!form.get('mapAddress')?.value">
                    Thêm đường dẫn embed Google Maps để hiển thị bản đồ.
                </div>
            </div>
        </div> -->
    </div>

    <!-- BOTTOM: danh sách phòng chiếu -->
    <section class="rooms-section">
        <div class="rooms-header">
            <h3>Danh sách phòng chiếu</h3>
            <button type="button" class="btn-primary" (click)="openRoomModal()">
                + Tạo phòng chiếu
            </button>
        </div>

        <div class="rooms-card">
            <table class="rooms-table">
                <thead>
                    <tr>
                        <th>Tên phòng chiếu</th>
                        <th>Loại phòng chiếu</th>
                        <th>Số lượng ghế (tối đa)</th>
                        <th>Số hàng</th>
                        <th>Số cột</th>
                        <th>Ngày tạo</th>
                        <th class="actions-col">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let r of rooms">
                        <td>{{ r.tenPhong }}</td>
                        <td>
                            <span class="tag" [ngClass]="mapLoaiPhongToLabel(r.loaiPhong)">
                                {{ r.loaiPhong }}
                            </span>

                        </td>
                        <!-- <td [ngClass]="{'configured': r.daCauHinh, 'not-configured': !r.daCauHinh}">
                            <ng-container *ngIf="r.daCauHinh">
                                ✅ Đã cấu hình
                            </ng-container>
                            <ng-container *ngIf="!r.daCauHinh">
                                ❌ Chưa cấu hình
                            </ng-container>
                        </td> -->
                        <td>{{ capacity(r) }}</td>
                        <td>{{ r.hang }} (A → {{ rowEndLetter(r.hang) }})</td>
                        <td>{{ r.cot }} (01 → {{ r.cot | number: '2.0' }})</td>
                        <td>{{ formatDate(r.createdAt) }}</td>
                        <td class="actions-col">
                            <button type="button" class="action-btn primary" title="Cấu hình ghế"
                                (click)="goToSeatConfig(r)">
                                <i class="fa-solid fa-gear"></i>
                            </button>
                            <button type="button" class="action-btn" title="Chỉnh sửa" (click)="editRoom(r)">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                            <button type="button" class="action-btn danger" title="Xóa" (click)="deleteRoom(r)">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>

                    <tr *ngIf="rooms.length === 0">
                        <td colspan="7" class="empty-row">
                            Chưa có phòng chiếu nào cho rạp này.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- Modal tạo phòng chiếu -->
    <!-- Modal tạo / cập nhật phòng chiếu -->
    <div class="modal-backdrop" *ngIf="isRoomModalOpen">
        <div class="room-modal">
            <div class="room-modal__header">
                <h3>
                    {{ editingRoom ? 'Cập nhật phòng chiếu' : 'Tạo phòng chiếu' }}
                </h3>
                <button type="button" class="room-modal__close" (click)="closeRoomModal()">
                    ×
                </button>
            </div>

            <form [formGroup]="roomForm" (ngSubmit)="saveRoom()">
                <div class="room-modal__body">
                    <div class="field-group">
                        <label class="field-label">
                            Tên phòng chiếu <span class="required">*</span>
                        </label>
                        <input type="text" class="field-input" placeholder="Nhập tên phòng chiếu"
                            formControlName="tenPhong" />
                    </div>

                    <div class="field-group">
                        <label class="field-label">
                            Loại phòng chiếu <span class="required">*</span>
                        </label>
                        <select class="field-input" formControlName="loaiPhong">
                            <option *ngFor="let t of loaiPhong" [value]="t">
                                {{ t }}
                            </option>
                        </select>
                    </div>

                    <div class="field-row">
                        <div class="field-group">
                            <label class="field-label">
                                Số hàng <span class="required">*</span>
                            </label>
                            <input type="number" class="field-input" placeholder="14" formControlName="hang" />
                        </div>

                        <div class="field-group">
                            <label class="field-label">
                                Số cột <span class="required">*</span>
                            </label>
                            <input type="number" class="field-input" placeholder="16" formControlName="cot" />
                        </div>
                    </div>
                </div>

                <div class="room-modal__footer">
                    <button class="btn-primary" type="submit">
                        {{ editingRoom ? 'Cập nhật' : 'Lưu' }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- <div class="modal-backdrop" *ngIf="isRoomModalOpen">
        <div class="room-modal">
            <div class="room-modal__header">
                <h3>Tạo phòng chiếu</h3>
                <button type="button" class="room-modal__close" (click)="closeRoomModal()">
                    ×
                </button>
            </div>

            <form [formGroup]="roomForm" (ngSubmit)="saveRoom()">
                <div class="room-modal__body">
                    <div class="field-group">
                        <label class="field-label">
                            Tên phòng chiếu <span class="required">*</span>
                        </label>
                        <input type="text" class="field-input" placeholder="Nhập tên phòng chiếu"
                            formControlName="name" />
                    </div>

                    <div class="field-group">
                        <label class="field-label">
                            Loại phòng chiếu <span class="required">*</span>
                        </label>
                        <select class="field-input" formControlName="type">
                            <option *ngFor="let t of roomTypes" [value]="t">
                                {{ t }}
                            </option>
                        </select>
                    </div>

                    <div class="field-row">
                        <div class="field-group">
                            <label class="field-label">
                                Số hàng <span class="required">*</span>
                            </label>
                            <input type="number" class="field-input" placeholder="14" formControlName="rows" />
                        </div>

                        <div class="field-group">
                            <label class="field-label">
                                Số cột <span class="required">*</span>
                            </label>
                            <input type="number" class="field-input" placeholder="16" formControlName="cols" />
                        </div>
                    </div>
                </div>

                <div class="room-modal__footer">
                    <button class="btn-primary" type="submit">
                        Lưu
                    </button>
                </div>
            </form>
        </div>
    </div> -->
</div>


<!-- Modal xác nhận xóa rạp -->
<div class="bm-modal-backdrop" *ngIf="confirmDeleteOpen">
    <div class="bm-modal">
        <h3 class="bm-modal-title">Xóa rạp chiếu</h3>
        <p class="bm-modal-message">
            Bạn có chắc chắn muốn xóa rạp
            <strong style="color: red">{{ cinema.tenRap }}</strong> không? Hành động này
            không thể hoàn tác.
        </p>
        <div class="bm-modal-actions">
            <button type="button" class="btn-outline" (click)="cancelDeleteCinema()">
                Hủy
            </button>
            <button type="button" class="btn-danger" (click)="confirmDeleteCinema()">
                Xóa
            </button>
        </div>
    </div>
</div>

<!-- Modal thông báo -->
<div class="bm-modal-backdrop" *ngIf="notifyOpen">
    <div class="bm-modal">
        <h3 class="bm-modal-title">{{ notifyTitle }}</h3>
        <p class="bm-modal-message">
            {{ notifyMessage }}
        </p>
        <div class="bm-modal-actions">
            <button type="button" class="btn-primary" (click)="closeNotify()">
                OK
            </button>
        </div>
    </div>
</div>